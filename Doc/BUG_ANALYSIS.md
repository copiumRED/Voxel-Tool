# BUG_ANALYSIS

Date: 2026-03-01
Scope: Main-branch code and current docs; no feature implementation in this run.

## Bug Backlog

| ID | Area | Symptom | Steps to Repro | Expected | Actual | Suspected Root Cause | Priority (P0/P1/P2) | Fix Strategy | Test Plan |
|---|---|---|---|---|---|---|---|---|---|
| B-001 | Viewport/Tools | Box/Line/Fill edits always occur on Z=0 plane | Create voxels above Z=0, use Box/Line/Fill on elevated surface | Tool applies on intended surface or selected plane | Edit lands on Z=0 | `_screen_to_plane_cell()` always returns `z=0` and is used by non-brush tools | P0 | Introduce shared 3D target resolver for non-brush tools with plane fallback mode | Add viewport interaction tests + manual elevated-surface smoke |
| B-002 | Picking | Pick mode toggle affects brush only | Toggle Surface/Plane Lock and run line/box/fill | All shape tools honor pick mode | Only brush changes | Non-brush handlers bypass pick-mode logic | P0 | Thread pick mode through non-brush preview + apply paths | Add regression tests for each tool in both modes |
| B-003 | Viewport UX | Grid and edit plane feel misaligned | Default scene; compare grid plane vs placement plane | Visual and edit axes align | Grid drawn at Y=0, edit fallback at Z=0 | Mixed axis conventions in render/input code | P0 | Unify coordinate conventions and expose active edit plane indicator | Add axis convention tests + manual camera preset checks |
| B-004 | Export/glTF | Scale preset shown but ignored for glTF | Export glTF using Unity vs Unreal presets | Output scale differs by preset | Output coordinates are identical | `export_voxels_to_gltf()` has no scale parameter | P0 | Extend glTF exporter options and apply scale transform | Add glTF export tests comparing coordinate scale |
| B-005 | Export/VOX | Scale preset shown but ignored for VOX | Export VOX with different presets and inspect XYZI | Preset either applied or hidden as unsupported | UI claims scale while payload unchanged | VOX exporter lacks scale handling; UI still displays preset | P0 | Disable scale option for VOX or implement explicit scaled export policy | Add UI-state + exporter behavior tests |
| B-006 | IO | Project open fails on harmless unknown keys | Add custom top-level field to saved project JSON and open | Loader tolerates unknown metadata | Loader rejects file | Strict unknown-key rejection in `load_project()` | P0 | Make loader forward-compatible with warning path | Add schema compatibility tests with extra keys |
| B-007 | Scene IDs | Part/group IDs repeat across process restarts | Start app twice; create first part/group each run | IDs globally unique | IDs restart from `part-1`/`group-1` | Counter-based ID generation | P1 | Migrate to UUID IDs with legacy counter-id support | Add ID uniqueness test across synthetic sessions |
| B-008 | Export/OBJ | Single material output regardless of palette complexity | Export multi-color model to OBJ/MTL | Distinct materials or documented color-only path | One `voxel_default` material only | `_write_mtl_file()` and `usemtl` are single-material | P1 | Add per-palette or per-face material grouping option | Add OBJ parser test asserting multi-material output when enabled |
| B-009 | Export/OBJ | Vertex colors may be wrong on shared vertices across differently colored faces | Construct mesh where faces share vertex but have different face colors | Predictable color policy per face/vertex | First-encounter color wins silently | `_build_vertex_color_map()` assigns first color per vertex | P1 | Define and implement explicit policy (split vertices or dominant color) | Add mesh fixture test for mixed-color adjacency |
| B-010 | Recovery | Recent edits can be lost before autosave tick | Edit voxel, force-close before 60s timer | Minimal loss or immediate queued snapshot | Last edits missing in recovery | Timer-only autosave (60s), no edit debounce | P1 | Add short debounce autosave on command commits | Add recovery timing test with controlled timers |
| B-011 | Viewport perf | `paintGL` recalculates visible voxel points multiple times per frame | Load dense scene and profile frame time | Single-pass data build per frame | Repeated list builds add overhead | `_visible_voxel_points()` called for count/frame/build paths | P1 | Cache per-frame visible rows/points in paint cycle | Add perf regression benchmark for dense scenes |
| B-012 | Stats | Runtime active voxel metric reports active part only | Multi-part scene with differing voxel counts | Stats can show per-scene and active-part clearly | Runtime uses active part count in combined context | `active_voxels=self.context.current_project.voxels.count()` in main window | P1 | Split metrics labels: active-part voxels vs scene voxels | Add stats formatting/unit tests |
| B-013 | Import/VOX | VOX imports ignore transform/hierarchy chunks | Import VOX with scene graph chunks | Reasonable transform/hierarchy mapping or explicit warning | Models imported only as raw grids | Parser handles SIZE/XYZI/RGBA only | P1 | Add chunk support roadmap + warning on unsupported chunks | Add parser tests for unsupported chunk warnings |
| B-014 | Workflow | Duplicate source trees can lead to wrong-entry edits | Modify similarly named file under `src/voxel_tool` accidentally | Single canonical path | Confusing dual trees remain | Legacy placeholder tree still present | P1 | Add contributor guardrails + deprecation plan for legacy tree | Add CI check to block edits outside canonical tree |
| B-015 | Undo UX | No transaction cancel path if drag starts and should abort | Begin drag then cancel interaction edge-case | Safe cancellation without history pollution | Potential empty/partial transaction behavior risk | Transaction lifecycle tied to mouse sequence only | P2 | Add explicit cancel/abort transaction flow in viewport input handler | Add input-cancel unit/integration tests |

## Notes
- The backlog includes confirmed behavior gaps and high-probability defects based on current code paths and documented constraints.
- Prioritization favors user-visible correctness (targeting/export/IO reliability) before optimization and polish.
